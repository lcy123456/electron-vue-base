{"version":3,"sources":["../../../electron/utils/autoUpdater/index.ts"],"sourcesContent":["import { BrowserWindow } from \"electron\";\nimport { autoUpdater } from \"electron-updater\";\nimport log from \"../log\";\n\nconst server = \"https://doc.ET2.com\";\n\nconst statusMap = {\n  error: { status: -1, message: \"更新出错\" },\n  checking: { status: 0, message: \"正在检查更新...\" },\n  updateAvailable: { status: 1, message: \"检测到新版本，准备开始下载...\" },\n  downloadProgress: { status: 2, message: \"新版本正在下载...\" },\n  updateDownloaded: { status: 3, message: \"新版本已下载成功，确定后安装最新版本\" },\n  updateNotAvailable: { status: 4, message: \"已经是最新版本\" },\n};\n\nexport const handleUpdate = (mainWindow: BrowserWindow) => {\n  autoUpdater.logger = log;\n  autoUpdater.autoDownload = false;\n\n  autoUpdater.on(\"checking-for-update\", () => {\n    console.log(\"Checking for update...\");\n    sendUpdateStatus(statusMap.checking);\n  });\n  autoUpdater.on(\"update-available\", (info) => {\n    console.log(\"Update available.\", info);\n    sendUpdateStatus(statusMap.updateAvailable);\n    autoUpdater.downloadUpdate();\n  });\n  autoUpdater.on(\"update-not-available\", (info) => {\n    console.log(\"Update not available.\", info);\n    sendUpdateStatus(statusMap.updateNotAvailable);\n  });\n  autoUpdater.on(\"error\", (err) => {\n    console.log(\"Error in auto-updater. \" + err);\n    sendUpdateStatus({\n      ...statusMap.error,\n      message: \"更新出错：\" + err,\n    });\n  });\n  autoUpdater.on(\"download-progress\", (progressInfo) => {\n    let log_message = \"Download speed: \" + progressInfo.bytesPerSecond;\n    log_message = log_message + \" - Downloaded \" + progressInfo.percent + \"%\";\n    log_message =\n      log_message + \" (\" + progressInfo.transferred + \"/\" + progressInfo.total + \")\";\n    console.log(log_message);\n    sendUpdateStatus({ ...statusMap.downloadProgress, progressInfo });\n  });\n  autoUpdater.on(\"update-downloaded\", (info) => {\n    console.log(\"Update downloaded\", info);\n    sendUpdateStatus(statusMap.updateDownloaded);\n  });\n\n  function sendUpdateStatus(data) {\n    mainWindow.webContents.send(\"updaterStatus\", data);\n  }\n};\n\nexport const setFeedURL = (version) => {\n  const url = `${server}/${process.platform}/${version}`;\n  autoUpdater.setFeedURL(url);\n  checkForUpdates();\n};\n\nexport const checkForUpdates = () => {\n  autoUpdater.checkForUpdates();\n};\n\nexport const quitAndInstall = () => {\n  global.forceQuit = true;\n  global.mainWindow.setClosable(true);\n  autoUpdater.quitAndInstall();\n};\n\nexport default autoUpdater;\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,8BAA4B;AAC5B,iBAAgB;AAEhB,MAAM,SAAS;AAEf,MAAM,YAAY;AAAA,EAChB,OAAO,EAAE,QAAQ,IAAI,SAAS,2BAAO;AAAA,EACrC,UAAU,EAAE,QAAQ,GAAG,SAAS,0CAAY;AAAA,EAC5C,iBAAiB,EAAE,QAAQ,GAAG,SAAS,oFAAmB;AAAA,EAC1D,kBAAkB,EAAE,QAAQ,GAAG,SAAS,gDAAa;AAAA,EACrD,kBAAkB,EAAE,QAAQ,GAAG,SAAS,+GAAqB;AAAA,EAC7D,oBAAoB,EAAE,QAAQ,GAAG,SAAS,6CAAU;AACtD;AAEO,MAAM,eAAe,CAAC,eAA8B;AACzD,sCAAY,SAAS,WAAAA;AACrB,sCAAY,eAAe;AAE3B,sCAAY,GAAG,uBAAuB,MAAM;AAC1C,YAAQ,IAAI,wBAAwB;AACpC,qBAAiB,UAAU,QAAQ;AAAA,EACrC,CAAC;AACD,sCAAY,GAAG,oBAAoB,CAAC,SAAS;AAC3C,YAAQ,IAAI,qBAAqB,IAAI;AACrC,qBAAiB,UAAU,eAAe;AAC1C,wCAAY,eAAe;AAAA,EAC7B,CAAC;AACD,sCAAY,GAAG,wBAAwB,CAAC,SAAS;AAC/C,YAAQ,IAAI,yBAAyB,IAAI;AACzC,qBAAiB,UAAU,kBAAkB;AAAA,EAC/C,CAAC;AACD,sCAAY,GAAG,SAAS,CAAC,QAAQ;AAC/B,YAAQ,IAAI,4BAA4B,GAAG;AAC3C,qBAAiB;AAAA,MACf,GAAG,UAAU;AAAA,MACb,SAAS,mCAAU;AAAA,IACrB,CAAC;AAAA,EACH,CAAC;AACD,sCAAY,GAAG,qBAAqB,CAAC,iBAAiB;AACpD,QAAI,cAAc,qBAAqB,aAAa;AACpD,kBAAc,cAAc,mBAAmB,aAAa,UAAU;AACtE,kBACE,cAAc,OAAO,aAAa,cAAc,MAAM,aAAa,QAAQ;AAC7E,YAAQ,IAAI,WAAW;AACvB,qBAAiB,EAAE,GAAG,UAAU,kBAAkB,aAAa,CAAC;AAAA,EAClE,CAAC;AACD,sCAAY,GAAG,qBAAqB,CAAC,SAAS;AAC5C,YAAQ,IAAI,qBAAqB,IAAI;AACrC,qBAAiB,UAAU,gBAAgB;AAAA,EAC7C,CAAC;AAED,WAAS,iBAAiB,MAAM;AAC9B,eAAW,YAAY,KAAK,iBAAiB,IAAI;AAAA,EACnD;AACF;AAEO,MAAM,aAAa,CAAC,YAAY;AACrC,QAAM,MAAM,GAAG,MAAM,IAAI,QAAQ,QAAQ,IAAI,OAAO;AACpD,sCAAY,WAAW,GAAG;AAC1B,kBAAgB;AAClB;AAEO,MAAM,kBAAkB,MAAM;AACnC,sCAAY,gBAAgB;AAC9B;AAEO,MAAM,iBAAiB,MAAM;AAClC,SAAO,YAAY;AACnB,SAAO,WAAW,YAAY,IAAI;AAClC,sCAAY,eAAe;AAC7B;AAEA,IAAO,gBAAQ;","names":["log"],"file":"index.js"}